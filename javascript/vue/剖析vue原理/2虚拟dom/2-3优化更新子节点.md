# 1.**前言**

当新的vnode与旧的vnode都是元素节点并且都有子节点的时候，vue会先循环外层newChildren数组元素，每循环外层newChildren数组里的一个子节点就去内层oldChildren数组里面找，看有没有与之相同的节点，进而根据情况作出不同的操作。  

当newChildren和oldChildren包含的子节点数量太多的时候，这样循环的时间复杂度就会变得很大，不利于性能提升。本篇我们就来学习一下vue如何针对这种情况进行优化的。


# 2.**优化策略介绍**
假设我们有一份新的newChildren数组和一份旧的oldChildren数组，如下所示：  
```javascript
newChildren = ['新子节点1', '新子节点2', '新子节点3', '新子节点4']
oldChildren = ['旧子节点1', '旧子节点2', '旧子节点3', '旧子节点4']
```

如果按照之前的解决方案，我们接下来的操作应该是这样的：从newChildren数组中拿出第一个子节点，用第一个子节点和oldChildren数组中的每个子节点进行比较，如果运气好，第一个旧的子节点刚好和第一个新的子节点相同，那就皆大欢喜，直接处理，不用再循环了。如果运气坏到极点，直到第四个旧的节点才比较出来和第一个新的节点相同，那么就会多循环4次。如果是最极端的情况，就是newChildren和oldChildren中的前三个节点是相同的，只有第四个节点是不同的，循环就会有16次比较，第16次循环的时候才发现第四个新节点和第四个旧节点不同，然后进行更新，如下图：  
<img alt='' src='./img/for.jpg' width="375px"/>

# 3. **新前与旧前**
把newChildren数组里所有未处理的子节点的第一个子节点和oldChildren数组里所有未处理子节点的第一个子节点做对比，如果相同，那好极了，直接进入之前所说的更新节点操作并且由于新前与旧前的两个节点位置也相同，无需进行节点移动操作，如下。如果不同，继续往后尝试。
<img alt='' src='./img/new-first-old-first.png' width="375px"/>

# 4. **新后与旧后**
把newChildren数组里所有未处理子节点的最后一个子节点和oldChildren数组里所有未处理子节点的最后一个子节点做对比，如果相同，那就直接进入更新节点的操作，并且由于新后与旧后两个节点的位置也下你沟通，无需进行节点移动操作；如果不同，继续往后尝试。
<img alt='' src='./img/new-old-last-old.png' width="375px"/>

# 5. **新后与旧前**
把newChildren数组里所有未处理子节点的最后一个子节点和oldChildren数组里所有未处理的第一个子节点做对比，如果相同，那么久进入更新节点操作，更新完之后将oldChildren数组里的该节点移动到与newChildren数组里节点相同的位置；
<img alt='' src='./img/new-last-old-first.png' width="375px"/>
此时，出现了移动节点的操作，移动节点最关键的地方在于找准要移动的位置。我们一再强调，更新节点要以新的vnode为基准，然后操作旧的oldVnode，使之最后旧的oldVnode与新的Vnode相同。那么现在的情况是：newChildren数组里最后一个子节点与oldChildren数组里的第一个子节点相同，那么我们应该在oldChildren数组里把第一个子节点移动到最后一个子节点的位置，如下图：
<img alt='' src='./img/new-last-old-first-move-vnode.png' width="375px"/>

# 6. **新前与旧后**
把newChildren数组里所有未处理子节点的第一个子节点和oldChildren数组里所有未处理的子节点的最后一个子节点做对比，如果相同，那么就直接进入更新节点的操作，更新完成后再将oldChildren数组里的该节点移动到与newChildren数组里节点相同的位置。
<img alt='' src='./img/new-first-old-last.png' width="375px"/>
同样，这种情况的节点移动位置逻辑与“新前与旧前”的逻辑类似，那就是newChildren数组里的第一个子节点与oldChildren数组里的最后一个子节点相同，那么我们就应该在oldChildren数组里把最后一个子节点移动到第一个子节点的位置，如下图：
<img alt='' src='./img/new-first-old-last-move-vnode.png' width="375px"/>
从图中不难看出，我们要把oldChildren数组里把最后一个子节点移动到数组中所有未处理的节点之前。

OK，以上就是子节点对比更新优化策略的4中情况，如果以上4中情况以此试过之后仍然没有找到相同的节点，那就进再通过之前的循环方式查找。

# 7.**回到源码**

# 8.**总结**